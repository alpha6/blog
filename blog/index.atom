<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://alpha6.ru</id>
    <title>Just another blog</title>
    <updated>2015-04-25T10:54:31Z</updated>
    <link rel="self" href="http://alpha6.ru/blog/index.atom"/>
    <link rel="alternate" href="http://alpha6.ru"/>
    <generator version="0.044">Statocles</generator>
    <entry>
        <id>http://alpha6.ru/blog/2015/04/25/stdout-autoflush</id>
        <title>stdout autoflush</title>
        <link rel="alternate" href="http://alpha6.ru/blog/2015/04/25/stdout-autoflush" />
        <content type="html"><![CDATA[
            <p>Классический метод:</p>

<pre><code>$oldfh = select(STDERR); $| = 1; select($oldfh);
</code></pre>

<p>ООП:</p>

<pre><code>use IO::Handle;
STDERR-&gt;autoflush(1);
</code></pre>

                <p><a href="http://alpha6.ru/blog/2015/04/25/stdout-autoflush#section-2">Continue reading...</a></p>
            <p>Tags:
                <a href="/blog/tag/snippet">snippet</a>
                <a href="/blog/tag/perl">perl</a>
                <a href="/blog/tag/io">io</a>
            </p>
        ]]></content>
        <updated>2015-04-25T00:00:00Z</updated>
        <category term="snippet" />
        <category term="perl" />
        <category term="io" />
    </entry>
    <entry>
        <id>http://alpha6.ru/blog/2015/04/23/ubuntu-14-04-gearman</id>
        <title>Ubuntu 14.04 + Gearman</title>
        <link rel="alternate" href="http://alpha6.ru/blog/2015/04/23/ubuntu-14-04-gearman" />
        <content type="html"><![CDATA[
            <p>В базовой установке Gearman в ubuntu 14.04 есть баг - инит-скрипт написан не правильно и в результате Gearman  не реагирует наличие конфиг файла и запускается с настойками по умолчанию. Причем, на одном из серверов у меня проблемма после обновления усугубилась и он перестал запускаться даже с настройками по умолчанию.</p>

<p>Есть два варианта решения проблемы:</p>

<ol>
<li>Пропатчить инит-скрипт, как это сделать можно прочитать <a href="http://jeremykendall.net/2014/09/04/ubuntu-14-dot-04-gearman-config-bug/">здесь</a></li>
<li>Запускать его из под supervisord.</li>
</ol>

<p>У меня все приложения крутятся под supervisor, так что я пошел этим путем. </p>

<p>Минимальный конфиг файл для супервизора:</p>

<pre><code>[program:gearmand]
command=/usr/sbin/gearmand -L 127.0.0.1 --user=gearman --log-file=stderr
autorestart=true
autostart=true
</code></pre>

<p><code>-L 127.0.0.1</code> указано, во первых, что-бы gearman не биндился на внешние интерфейсы (там все закрыто фаирволом, но все же). Во вторых - если на машине включен ipv6, но не настроен, то gearman будет пытаться забиндиться и на ipv6 и падать.</p>

<p>З.Ы. инит для supervisord в 14.04 тоже кривой, но это уже другая история.</p>

                <p><a href="http://alpha6.ru/blog/2015/04/23/ubuntu-14-04-gearman#section-2">Continue reading...</a></p>
            <p>Tags:
                <a href="/blog/tag/ubuntu">ubuntu</a>
                <a href="/blog/tag/gearman">gearman</a>
                <a href="/blog/tag/bugs">bugs</a>
            </p>
        ]]></content>
        <updated>2015-04-23T00:00:00Z</updated>
        <category term="ubuntu" />
        <category term="gearman" />
        <category term="bugs" />
    </entry>
    <entry>
        <id>http://alpha6.ru/blog/2015/04/11/starting-with-rex</id>
        <title>Starting with Rex</title>
        <link rel="alternate" href="http://alpha6.ru/blog/2015/04/11/starting-with-rex" />
        <content type="html"><![CDATA[
            <p>В жизни каждого человека настает момент когда ему становится лениво делать одно и то же на удаленных серверах и хочется автоматизации.</p>

<p>В решении этой тяжелой жизненной проблемы нам поможет <a href="http://www.rexify.org">R(?)ex</a>.</p>

<p><strong>Небольшой F.A.Q</strong></p>

<p><strong><em>Что это?</em></strong></p>

<p>Это приложение для управления удаленными(и не очень) серверами и приложениями.</p>

<p><strong><em>Я могу просто написать bash/perl/pithon/ruby/etc-скрипт и он сделает то же самое.</em></strong></p>

<p>Несомненно, но это будет очередное изобретение велосипеда с колесами разной степеньи квадратности. </p>

<p><strong><em>Почему не Puppet/Ansible?</em></strong></p>

<p>Потому что здесь про Perl, но сравнение Rex и Ansible я еще сделаю.</p>

<p><strong>Поехали</strong></p>

<p>Во первых, Rex можно использовать для простого запуска команд на удаленном сервере:</p>

<p><code>rex -H "example.com example.ru" -e "say run 'uptime'"</code></p>

<p>Задачи выполняются последовательно, так что придется подождать пока опросятся все сервера, особенно если их много.</p>

<p>Запуск из консоли это вариант если надо что-то и единоразово посмотреть что там на серверах творится. Но постоянно набирать команды в консоли это решение для сильных духом и памятью.
Мы же как, настоящие программисты, будем осваивать командные файлы.</p>

<p>По умолчанию Rex использует файл под названием Rexfile (удивительное совпадение).</p>

<p>Попробуем сделать что-то полезное.</p>

<p>Создадим Rexfile который будет содержать команду <code>deploy</code>. По этой команде Rex пойдет на удаленный сервер и сделает там <code>git pull</code> для сайта. Простейшний вариант деплоя.</p>

<pre><code> use Rex -feature =&gt; ['1.0'];

 user "myuser";
 private_key "/home/myuser/.ssh/id_rsa";
 public_key "/home/myuser/.ssh/id_rsa.pub";
 key_auth;

 group myservers =&gt; "example.ru";

 desc "Deploy the blog on example.ru";
 task "deploy", group =&gt; "myservers", sub {
   run "cd /srv/www/example.ru &amp;&amp; git pull origin gh-pages";
 };
</code></pre>

<p>Теперь можно сказать: <code>rex deploy</code></p>

<p>Дальше Rex залогинится под пользователем "myuser" с использованием указанных ключей и выполнит команду указанную в опции run. Если пользователь на удаленном сервер совпадает с текущим - то первую секцию можно опустить. Будет использоваться текущий пользователь и его настройки ключей для ssh. Но если планируется использование команды через cron - то указывать надо обязательно, иначе ничего работать не будет.</p>

<p>Так же можно обновлять конфигурацию копируя на хосты необходимые файлы (вы же не храните авторизационные данные в Git, правда?)
приведем содержимое раздела task к виду:</p>

<pre><code> run "cd /srv/www/example.ru &amp;&amp; git pull origin gh-pages";
 file "/srv/www/example.ru/test.conf",
     source    =&gt; "files/test.conf";
</code></pre>

<p>Теперь при выполнении <code>rex deploy</code> будет выполнен <code>pull</code> из репозитория на удаленном сервере, а затем туда будет скопирован файл <code>files/test.conf</code>.</p>

<p>В принципе, этого совершенно достаточно для деплоя простого сайта не требующего перезапуска сервисов. Таким скриптом деплоится этот блог. Пошаговый мануал о том, как сделать настройку сервера с нуля до продакшена одной командой будет в следующей статье.</p>

<p>А те кому не хочется ждать - могут почитать <a href="http://www.rexify.org/howtos/index.html#howtos">официальную документацию</a>, она весьма подробная и с хорошими примерами.</p>

                <p><a href="http://alpha6.ru/blog/2015/04/11/starting-with-rex#section-2">Continue reading...</a></p>
            <p>Tags:
                <a href="/blog/tag/Rex">Rex</a>
                <a href="/blog/tag/Perl">Perl</a>
                <a href="/blog/tag/Automation">Automation</a>
            </p>
        ]]></content>
        <updated>2015-04-11T00:00:00Z</updated>
        <category term="Rex" />
        <category term="Perl" />
        <category term="Automation" />
    </entry>
    <entry>
        <id>http://alpha6.ru/blog/2015/04/09/ubuntu-lc_all=(unset)</id>
        <title>Ubuntu LC_ALL = (unset)</title>
        <link rel="alternate" href="http://alpha6.ru/blog/2015/04/09/ubuntu-lc_all=(unset)" />
        <content type="html"><![CDATA[
            <p>При установке Ubuntu (в основном на VDS) периодический вылезает ошибка:</p>

<pre><code>LANGUAGE = (unset)
LC_ALL = (unset)
</code></pre>

<p>Для исправления делаем:</p>

<pre><code># echo LC_ALL="ru_RU.UTF-8" &gt;&gt; /etc/environment
# locale-gen ru_RU.UTF-8
</code></pre>

<p>И перелегониваемся.</p>

                <p><a href="http://alpha6.ru/blog/2015/04/09/ubuntu-lc_all=(unset)#section-2">Continue reading...</a></p>
            <p>Tags:
                <a href="/blog/tag/Ubuntu">Ubuntu</a>
                <a href="/blog/tag/LC_ALL">LC_ALL</a>
            </p>
        ]]></content>
        <updated>2015-04-09T00:00:00Z</updated>
        <category term="Ubuntu" />
        <category term="LC_ALL" />
    </entry>
</feed>

