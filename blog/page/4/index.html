<!DOCTYPE html>
<html>
    <head>
	<meta charset="UTF-8">
        <link href="/theme/css/normalize.css" rel="stylesheet">
        <link href="/theme/css/skeleton.css" rel="stylesheet">
        <link href="/theme/css/statocles-default.css" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Just another blog</title>
        <meta content="Statocles 0.077" name="generator">
        <link href="/blog/index.atom" rel="alternate" type="application/atom+xml">
        <link href="/blog/index.rss" rel="alternate" type="application/rss+xml">
        
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">Just another blog</a>
                    <ul>
                        <li>
                            <a href="/">Blog</a>
                        </li>
                    </ul>
                    
                </div>
            </nav>
            
        </header>
        <div class="main container">
            
<div class="row">

    <div class="nine columns">
        <main>


            <article>
                <header>
                    <h1><a href="/blog/2015/05/20/airport-linux/">Превращаем Linux компьютер в AirPlay приемник</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/airplay/" rel="tag">airplay</a>
                        <a href="/blog/tag/linux/" rel="tag">linux</a>
                        <a href="/blog/tag/shairport/" rel="tag">shairport</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-05-20">
                            Posted on 2015-05-20
                        </time>
                        <a data-disqus-identifier="/2015/05/20/airport-linux/index.markdown" href="/blog/2015/05/20/airport-linux/#disqus_thread">0 comments</a>
                        </p>
                    </aside>

                </header>

                <p>Захотелось мне как-то играть музыку с мака на колонки без проводов. Раньше для этого я пользовался AirPort Express, када были воткнуты колонки. Но сия халява кончилась и теперь надо что-то изобретать.</p>

<p>Быстрый поиск по интернетам показал существование демона shairport, который предствляет собой AirPlay приемник для Linux. Проблема в том, что данный демон уже давно не поддерживается и автор прямо отказался от его поддержки. Но благодаря великой силе форков гитхаба был найден проект <a href="https://github.com/mikebrady/shairport-sync">shairport-sync</a>, который является форком shairport с допилами и поддерживается в настоящее время. То что надо!</p>

<p>Итак, краткий мануал по установке. Я взял старый asus eee 900, на котором стоит xubuntu 14.04LTS. По совместительству он работает у меня домашним сервером.</p>

<ul>
<li>Клонируем к себе репозиторий <code>git clone https://github.com/mikebrady/shairport-sync.git</code></li>
<li>Устанавливаем зависимости нужное для сборки <code>apt install build-essential autoconf checkinstall libtool libdaemon-dev libasound2-dev libpopt-dev</code></li>
<li>Устанавливаем Avahi <code>apt install avahi-daemon libavahi-client-dev</code></li>
<li>Устанавливаем зависимости для работы с SSL <code>apt install libssl-dev</code>. Демон умеет работать с OpenSSL или PolarSSL, но этот пакет нужен для обеих библиотек.</li>
<li>Я использовал PolarSSL для сборки, но, в целом, никакой разницы нет. Устанавливаем PolarSSL <code>apt install libpolarssl-dev</code></li>
<li>Запускаем autoconf <code>autoreconf -i -f</code> после этого будет сгенерирован файл configure.</li>
<li><code>$ ./configure --with-alsa --with-avahi --with-ssl=polarssl</code></li>
<li><code>make</code></li>
<li><code>sudo checkinstall</code>. Checkinstall задаст несколько вопросов, на них можно ответить по умолчанию, единственное что надо задать поле <code>version</code> в виде числа. Т.к. по умолчанию туда попадает значение <code>sync</code> и checkinstall падает с ошибкой создания пакета.</li>
</ul>

<p>Почему вместо <code>make install</code> лучше использовать <code>checkinstall</code>? Эта утилита перехватит работу make, отследит куда ставятся все файлы приложения и создаст deb пакет для безопасной установки и удаления приложения.</p>

<p>Конфигурируется демон через редактирования файла <code>/etc/init.d/shairport-sync</code>, я там поменял только название сервиса. Обычно больше ничего не требуется для работы.</p>

<h3>Возможные проблемы</h3>

<p>При загрузке компьютера может появляться сообщение:</p>

<pre><code>Avahi detected that your currently configured local DNS server serves a domain .local. This is inherently incompatible with Avahi and thus Avahi disabled itself. If you want to use Avahi in this network, please contact your administrator and convince him to use a different DNS domain, since .local should be used exclusively for Zeroconf technology.
</code></pre>

<p>Работа Avahi будет останавливаться, соответственно и shairport не запустится. Обычно эта проблема связана с тем, что в DNS сервере есть записи для зоны local.</p>

<p>Проверяется это командой: <code>host -t SOA local.</code> (обратите внимание на точку в конце!). В нормальной ситуации вывод должен быть около такого: </p>

<pre><code>bash-3.2$ host -t SOA local.
Host local. not found: 3(NXDOMAIN)
</code></pre>

<p>Если же в выводе написано: <code>local has SOA record XXX</code>, то ваш DNS транслирует зону local. Обычно это делают провайдеры для работы сервисов типа retracker.local. Если вы этим не пользуетесь - можно просто указать днс Yandex (77.88.8.8/77.88.8.1) или Google(8.8.8.8/8.8.4.4).</p>

<p>После этих настроек и рестарта служб - все должно работать, а на устройствах Apple появится ваше устройство для вывода звука.</p>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2015/05/02/elasticsearch-remove-messages/">Remove messages from Graylog2</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/graylog2/" rel="tag">graylog2</a>
                        <a href="/blog/tag/elasticsearch/" rel="tag">elasticsearch</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-05-02">
                            Posted on 2015-05-02
                        </time>
                        <a data-disqus-identifier="/2015/05/02/elasticsearch-remove-messages/index.markdown" href="/blog/2015/05/02/elasticsearch-remove-messages/#disqus_thread">0 comments</a>
                        </p>
                    </aside>

                </header>

                <p>If you want to remove all messages with requested pattern in message body, you have to write following line:</p>

<p>curl -XDELETE &#39;http://graylog.example:9200/graylog_*/message/_query&#39; -d&#39;{&quot;query&quot; : {&quot;match&quot;: { &quot;message&quot; : &quot;SearchPattern&quot;}}}&#39;</p>

<p>remove exact pattern:
curl -XDELETE &#39;http://graylog.example:9200/graylog_*/message/_query&#39; -d&#39;{&quot;query&quot; : {&quot;term&quot;: { &quot;message&quot; : &quot;ExactText&quot;}}}&#39;</p>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2015/04/30/using-perl-and-graylog/">Используем Graylog с Perl</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/perl/" rel="tag">perl</a>
                        <a href="/blog/tag/graylog/" rel="tag">graylog</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-04-30">
                            Posted on 2015-04-30
                        </time>
                        <a data-disqus-identifier="/2015/04/30/using-perl-and-graylog/index.markdown" href="/blog/2015/04/30/using-perl-and-graylog/#disqus_thread">0 comments</a>
                        </p>
                    </aside>

                </header>

                <p>Устанавливаем Graylog. Для опытов я использовал преднастроенную VM для VirtualBox http://docs.graylog.org/en/1.0/pages/installation.html#virtual-machine-appliances</p>

<p>! На момент написания статьи в VM идет версия Graylog-web с багом - при создании dashboard на нее нельзя добавить виджет т.к. JS-скрипт ответственный за разблокировку dashboard падает с ошибкой. Что-бы что-то сделать с дэшбордом на него надо добавить любой виджет с любой страницы. Это делается по клику на иконку возле названия виджета и выбором нужного дэшборда.</p>

<p>Первым делом надо создать Input для логов.
Мы будем использовать GELF формат через Log::Log4perl.
Идем System-&gt;Inputs в выпадающем списке выбираем GELF UDP и жмем Launch Input.
В открывшемся окне выбираем ноды на которых будет работать этот инпут, описание, адрес на котором он будет слушать.
Жмем launch, убеждаемся что он стартанул и на этом пока все работы с Graylog закончены.</p>

<p>Теперь устанавливаем пакет <a href="https://metacpan.org/pod/Log::Log4perl::Layout::GELF">Log::Log4perl::Layout::GELF</a>.</p>

<p>Создаем файл конфигурации логгера:</p>

<pre><code>log4perl.logger.graylog                     = INFO, Screen, Graylog

log4perl.appender.Screen                = Log::Log4perl::Appender::Screen
log4perl.appender.Screen.stderr         = 0
log4perl.appender.Screen.layout         = Log::Log4perl::Layout::PatternLayout
log4perl.appender.Screen.layout.ConversionPattern = [%d] [%p] %m%n
log4perl.appender.Screen.utf8           = 1

log4perl.appender.Graylog          = Log::Log4perl::Appender::Socket
log4perl.appender.Graylog.PeerAddr = graylog.host
log4perl.appender.Graylog.PeerPort = 12201
log4perl.appender.Graylog.Proto    = udp
log4perl.appender.Graylog.layout   = GELF
</code></pre>

<p>Создаем тестовый скрипт:</p>

<pre><code>#!/usr/bin/env perl

use utf8;
use strict;
use Log::Log4perl;

#Загружаем конфигурацию 
Log::Log4perl::init(&#39;logger.conf&#39;);

#Получаем логгер
my $logger = Log::Log4perl-&gt;get_logger(&#39;graylog&#39;);

$logger-&gt;info(&#39;hello graylog&#39;);
$logger-&gt;info(&#39;Тестовое сообщение UTF8&#39;);
</code></pre>

<p>В теории, этого достаточно для того что бы нужные логи вашего приложения начали идти в Graylog. Но, как обычно, есть нюанс - этот модуль совершенно не представляет что есть более чем однобайтные кодировки и при попытке что-то записать в лог что-то с utf8 мы получим ошибку <code>Wide character in IO::Compress::Gzip::write</code> и в Graylog сообщение не придет.</p>

<p>Для обычных аппендеров, например Screen, эта проблема решается просто - дописываем в конфигурацию флаг включения utf8:</p>

<pre><code>log4perl.appender.FileAppndr.utf8     = 1
</code></pre>

<p>Но в данном случае проблема на уровне layout и этот модуль не обрабатывает такую ситуацию.</p>

<p>Для себя я эту проблему решил просто - сделал форк модуля с названием <a href="https://github.com/alpha6/Log-Log4perl-Layout-GELFUtf">GELFUtf</a> и использую его.</p>

<p>Таким образом в конфиге вместо <code>log4perl.appender.Graylog.layout   = GELF</code> пишу <code>log4perl.appender.Graylog.layout   = GELFUtf</code>.</p>

<p>Подменить фунцию на лету у меня не получилось, скорее всего из-за хитрой архитектуры Log4perl. А лезть патчить в рантайм - овчинка выделки не стоит. Так что пока пользуюсь патченым модулем и коплю силы на создание полноценного патча для оригинального модуля.</p>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2015/04/25/stdout-autoflush/">stdout autoflush</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/snippet/" rel="tag">snippet</a>
                        <a href="/blog/tag/perl/" rel="tag">perl</a>
                        <a href="/blog/tag/io/" rel="tag">io</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-04-25">
                            Posted on 2015-04-25
                        </time>
                        <a data-disqus-identifier="/2015/04/25/stdout-autoflush/index.markdown" href="/blog/2015/04/25/stdout-autoflush/#disqus_thread">0 comments</a>
                        </p>
                    </aside>

                </header>

                <p>Классический метод:</p>

<pre><code>$oldfh = select(STDERR); $| = 1; select($oldfh);
</code></pre>

<p>ООП:</p>

<pre><code>use IO::Handle;
STDERR-&gt;autoflush(1);
</code></pre>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2015/04/23/ubuntu-14-04-gearman/">Ubuntu 14.04 + Gearman</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/ubuntu/" rel="tag">ubuntu</a>
                        <a href="/blog/tag/gearman/" rel="tag">gearman</a>
                        <a href="/blog/tag/bugs/" rel="tag">bugs</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-04-23">
                            Posted on 2015-04-23
                        </time>
                        <a data-disqus-identifier="/2015/04/23/ubuntu-14-04-gearman/index.markdown" href="/blog/2015/04/23/ubuntu-14-04-gearman/#disqus_thread">0 comments</a>
                        </p>
                    </aside>

                </header>

                <p>В базовой установке Gearman в ubuntu 14.04 есть баг - инит-скрипт написан не правильно и в результате Gearman  не реагирует наличие конфиг файла и запускается с настойками по умолчанию. Причем, на одном из серверов у меня проблемма после обновления усугубилась и он перестал запускаться даже с настройками по умолчанию.</p>

<p>Есть два варианта решения проблемы:</p>

<ol>
<li>Пропатчить инит-скрипт, как это сделать можно прочитать <a href="http://jeremykendall.net/2014/09/04/ubuntu-14-dot-04-gearman-config-bug/">здесь</a></li>
<li>Запускать его из под supervisord.</li>
</ol>

<p>У меня все приложения крутятся под supervisor, так что я пошел этим путем. </p>

<p>Минимальный конфиг файл для супервизора:</p>

<pre><code>[program:gearmand]
command=/usr/sbin/gearmand -L 127.0.0.1 --user=gearman --log-file=stderr
autorestart=true
autostart=true
</code></pre>

<p><code>-L 127.0.0.1</code> указано, во первых, что-бы gearman не биндился на внешние интерфейсы (там все закрыто фаирволом, но все же). Во вторых - если на машине включен ipv6, но не настроен, то gearman будет пытаться забиндиться и на ipv6 и падать.</p>

<p>З.Ы. инит для supervisord в 14.04 тоже кривой, но это уже другая история.</p>



            </article>
        </main>

        <ul class="pager">
            <li class="prev">
                <a class="button button-primary" href="/blog/page/5" rel="next">
                    ← Older
                </a>
            </li>
            <li class="next">
                <a class="button button-primary" href="/blog/page/3" rel="prev">
                    Newer →
                </a>
            </li>
        </ul>

    </div>

    <div class="three columns sidebar">
        
        <h1>Tags</h1>
        <ul class="list-inline">
            <li><a href="/blog/tag/3dprinting/">3dprinting</a></li>
            <li><a href="/blog/tag/airplay/">airplay</a></li>
            <li><a href="/blog/tag/armbian/">armbian</a></li>
            <li><a href="/blog/tag/automation/">Automation</a></li>
            <li><a href="/blog/tag/bugs/">bugs</a></li>
            <li><a href="/blog/tag/data/">data</a></li>
            <li><a href="/blog/tag/dbd-pg/">DBD::Pg</a></li>
            <li><a href="/blog/tag/debian/">debian</a></li>
            <li><a href="/blog/tag/diy/">diy</a></li>
            <li><a href="/blog/tag/elasticsearch/">elasticsearch</a></li>
            <li><a href="/blog/tag/elcapitan/">ElCapitan</a></li>
            <li><a href="/blog/tag/email/">email</a></li>
            <li><a href="/blog/tag/gearman/">gearman</a></li>
            <li><a href="/blog/tag/git/">git</a></li>
            <li><a href="/blog/tag/graylog/">graylog</a></li>
            <li><a href="/blog/tag/graylog2/">graylog2</a></li>
            <li><a href="/blog/tag/io/">io</a></li>
            <li><a href="/blog/tag/java/">java</a></li>
            <li><a href="/blog/tag/jcifs/">jcifs</a></li>
            <li><a href="/blog/tag/kodi/">kodi</a></li>
            <li><a href="/blog/tag/lc_all/">LC_ALL</a></li>
            <li><a href="/blog/tag/linux/">linux</a></li>
            <li><a href="/blog/tag/macos/">MacOS</a></li>
            <li><a href="/blog/tag/marlin/">marlin</a></li>
            <li><a href="/blog/tag/net-smtp/">Net::SMTP</a></li>
            <li><a href="/blog/tag/nginx/">nginx</a></li>
            <li><a href="/blog/tag/note/">note</a></li>
            <li><a href="/blog/tag/orange-pi/">orange pi</a></li>
            <li><a href="/blog/tag/orangepi/">orangepi</a></li>
            <li><a href="/blog/tag/package/">package</a></li>
            <li><a href="/blog/tag/perl/">perl</a></li>
            <li><a href="/blog/tag/postgresql/">postgresql</a></li>
            <li><a href="/blog/tag/power/">power</a></li>
            <li><a href="/blog/tag/prusai3/">prusai3</a></li>
            <li><a href="/blog/tag/ramps/">ramps</a></li>
            <li><a href="/blog/tag/redmine/">Redmine</a></li>
            <li><a href="/blog/tag/rex/">Rex</a></li>
            <li><a href="/blog/tag/samba/">samba</a></li>
            <li><a href="/blog/tag/shairport/">shairport</a></li>
            <li><a href="/blog/tag/slic3r/">Slic3r</a></li>
            <li><a href="/blog/tag/snippet/">snippet</a></li>
            <li><a href="/blog/tag/spotlight/">Spotlight</a></li>
            <li><a href="/blog/tag/state/">state</a></li>
            <li><a href="/blog/tag/timestamp/">timestamp</a></li>
            <li><a href="/blog/tag/trap/">trap</a></li>
            <li><a href="/blog/tag/ubuntu/">Ubuntu</a></li>
            <li><a href="/blog/tag/windows/">windows</a></li>
        </ul>
        <h1>Feeds</h1>
        <ul class="list-inline">
            <li>
                <a href="/blog/index.atom" rel="alternate" type="application/atom+xml">
                    Atom
                </a>
            </li>
            <li>
                <a href="/blog/index.rss" rel="alternate" type="application/rss+xml">
                    RSS
                </a>
            </li>
        </ul>
    </div>

</div>

<script type="text/javascript">
    var disqus_shortname = 'alpha6sblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

            <div id="disqus_thread"></div>
            <script>
            /**
            * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
            */
            /*
            var disqus_config = function () {
            this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
            };
            */
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');  s.src = '//alpha6sblog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
        <footer>
            
            <div class="container tagline">
                <a href="http://preaction.github.io/Statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>

            <script async id="dsq-count-scr" src="//alpha6sblog.disqus.com/count.js"></script>
            <!-- Yandex.Metrika counter --><script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter7948447 = new Ya.Metrika({ id:7948447, clickmap:true, trackLinks:true, accurateTrackBounce:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img alt="" src="https://mc.yandex.ru/watch/7948447" style="position:absolute; left:-9999px;"></div></noscript><!-- /Yandex.Metrika counter -->
            <!-- Google analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-7392296-3', 'auto');ga('send', 'pageview');</script>
        </footer>
    </body>
</html>
