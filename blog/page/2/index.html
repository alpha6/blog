<!DOCTYPE html>
<html>
    <head>
	<meta charset="utf-8" />
        <link rel="stylesheet" href="/theme/css/normalize.css" />
        <link rel="stylesheet" href="/theme/css/skeleton.css" />
        <link rel="stylesheet" href="/theme/css/statocles-default.css" />
        <title>Just another blog</title>
        <link rel="alternate" href="/blog/index.atom" type="application/atom+xml" />
        <link rel="alternate" href="/blog/index.rss" type="application/rss+xml" />
        
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">Just another blog</a>
                    <ul>
                        <li>
                            <a href="/">Blog</a>
                        </li>
                    </ul>
                </div>
            </nav>
            
        </header>
        <div class="main container">
            
<div class="row">

    <div class="nine columns">
        <main>

            <article>
                <header>
                    <h1><a href="/blog/2015/04/11/starting-with-rex">Starting with Rex</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/Rex" rel="tag">Rex</a>
                        <a href="/blog/tag/Perl" rel="tag">Perl</a>
                        <a href="/blog/tag/Automation" rel="tag">Automation</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-04-11">
                            Posted on 2015-04-11
                        </time>
                        </p>
                    </aside>

                </header>

                <p>В жизни каждого человека настает момент когда ему становится лениво делать одно и то же на удаленных серверах и хочется автоматизации.</p>

<p>В решении этой тяжелой жизненной проблемы нам поможет <a href="http://www.rexify.org">R(?)ex</a>.</p>

<p><strong>Небольшой F.A.Q</strong></p>

<p><strong><em>Что это?</em></strong></p>

<p>Это приложение для управления удаленными(и не очень) серверами и приложениями.</p>

<p><strong><em>Я могу просто написать bash/perl/pithon/ruby/etc-скрипт и он сделает то же самое.</em></strong></p>

<p>Несомненно, но это будет очередное изобретение велосипеда с колесами разной степеньи квадратности. </p>

<p><strong><em>Почему не Puppet/Ansible?</em></strong></p>

<p>Потому что здесь про Perl, но сравнение Rex и Ansible я еще сделаю.</p>

<p><strong>Поехали</strong></p>

<p>Во первых, Rex можно использовать для простого запуска команд на удаленном сервере:</p>

<p><code>rex -H "example.com example.ru" -e "say run 'uptime'"</code></p>

<p>Задачи выполняются последовательно, так что придется подождать пока опросятся все сервера, особенно если их много.</p>

<p>Запуск из консоли это вариант если надо что-то и единоразово посмотреть что там на серверах творится. Но постоянно набирать команды в консоли это решение для сильных духом и памятью.
Мы же как, настоящие программисты, будем осваивать командные файлы.</p>

<p>По умолчанию Rex использует файл под названием Rexfile (удивительное совпадение).</p>

<p>Попробуем сделать что-то полезное.</p>

<p>Создадим Rexfile который будет содержать команду <code>deploy</code>. По этой команде Rex пойдет на удаленный сервер и сделает там <code>git pull</code> для сайта. Простейшний вариант деплоя.</p>

<pre><code> use Rex -feature =&gt; ['1.0'];

 user "myuser";
 private_key "/home/myuser/.ssh/id_rsa";
 public_key "/home/myuser/.ssh/id_rsa.pub";
 key_auth;

 group myservers =&gt; "example.ru";

 desc "Deploy the blog on example.ru";
 task "deploy", group =&gt; "myservers", sub {
   run "cd /srv/www/example.ru &amp;&amp; git pull origin gh-pages";
 };
</code></pre>

<p>Теперь можно сказать: <code>rex deploy</code></p>

<p>Дальше Rex залогинится под пользователем "myuser" с использованием указанных ключей и выполнит команду указанную в опции run. Если пользователь на удаленном сервер совпадает с текущим - то первую секцию можно опустить. Будет использоваться текущий пользователь и его настройки ключей для ssh. Но если планируется использование команды через cron - то указывать надо обязательно, иначе ничего работать не будет.</p>

<p>Так же можно обновлять конфигурацию копируя на хосты необходимые файлы (вы же не храните авторизационные данные в Git, правда?)
приведем содержимое раздела task к виду:</p>

<pre><code> run "cd /srv/www/example.ru &amp;&amp; git pull origin gh-pages";
 file "/srv/www/example.ru/test.conf",
     source    =&gt; "files/test.conf";
</code></pre>

<p>Теперь при выполнении <code>rex deploy</code> будет выполнен <code>pull</code> из репозитория на удаленном сервере, а затем туда будет скопирован файл <code>files/test.conf</code>.</p>

<p>В принципе, этого совершенно достаточно для деплоя простого сайта не требующего перезапуска сервисов. Таким скриптом деплоится этот блог. Пошаговый мануал о том, как сделать настройку сервера с нуля до продакшена одной командой будет в следующей статье.</p>

<p>А те кому не хочется ждать - могут почитать <a href="http://www.rexify.org/howtos/index.html#howtos">официальную документацию</a>, она весьма подробная и с хорошими примерами.</p>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2015/04/09/ubuntu-lc_all=(unset)">Ubuntu LC_ALL = (unset)</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/Ubuntu" rel="tag">Ubuntu</a>
                        <a href="/blog/tag/LC_ALL" rel="tag">LC_ALL</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-04-09">
                            Posted on 2015-04-09
                        </time>
                        </p>
                    </aside>

                </header>

                <p>При установке Ubuntu (в основном на VDS) периодический вылезает ошибка:</p>

<pre><code>LANGUAGE = (unset)
LC_ALL = (unset)
</code></pre>

<p>Для исправления делаем:</p>

<pre><code># echo LC_ALL="ru_RU.UTF-8" &gt;&gt; /etc/environment
# locale-gen ru_RU.UTF-8
</code></pre>

<p>И перелегониваемся.</p>



            </article>
        </main>

        <ul class="pager">
            <li class="prev">
                <a class="button disabled"
                    rel="next" href=""
                >
                    &larr; Older
                </a>
            </li>
            <li class="next">
                <a class="button button-primary"
                    rel="prev" href="index.html"
                >
                    Newer &rarr;
                </a>
            </li>
        </ul>

    </div>

    <div class="three columns sidebar">
        
        <h1>Tags</h1>
        <ul class="list-inline">
            <li><a href="/blog/tag/Automation">Automation</a></li>
            <li><a href="/blog/tag/LC_ALL">LC_ALL</a></li>
            <li><a href="/blog/tag/Perl">Perl</a></li>
            <li><a href="/blog/tag/Rex">Rex</a></li>
            <li><a href="/blog/tag/Ubuntu">Ubuntu</a></li>
            <li><a href="/blog/tag/airplay">airplay</a></li>
            <li><a href="/blog/tag/bugs">bugs</a></li>
            <li><a href="/blog/tag/elasticsearch">elasticsearch</a></li>
            <li><a href="/blog/tag/gearman">gearman</a></li>
            <li><a href="/blog/tag/graylog">graylog</a></li>
            <li><a href="/blog/tag/graylog2">graylog2</a></li>
            <li><a href="/blog/tag/io">io</a></li>
            <li><a href="/blog/tag/linux">linux</a></li>
            <li><a href="/blog/tag/perl">perl</a></li>
            <li><a href="/blog/tag/shairport">shairport</a></li>
            <li><a href="/blog/tag/snippet">snippet</a></li>
            <li><a href="/blog/tag/ubuntu">ubuntu</a></li>
        </ul>
        <h1>Feeds</h1>
        <ul class="list-inline">
            <li>
                <a href="/blog/index.atom" rel="alternate" type="application/atom+xml">
                    Atom
                </a>
            </li>
            <li>
                <a href="/blog/index.rss" rel="alternate" type="application/rss+xml">
                    RSS
                </a>
            </li>
        </ul>
    </div>

</div>

        </div>
        <footer>
            
            <div class="container tagline">
                <a href="http://preaction.github.io/Statocles">Made with Statocles</a><br/>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
	<!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter7948447 = new Ya.Metrika({id:7948447, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/7948447" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->
    </body>
</html>
