---
tags: prusai3, marlin, Slic3r
title: Добавляем второй экструдер к RAMPS 1.4/Marlin
---
В [прошлой серии](http://alpha6.ru/blog/2016/08/23/marlin-setup/) мы установили прошивку Marin на Arduino Mega+RAMPS 1.4 и откалибровали все это дело. Теперь пришло время добавить второй экструдер.

Для этого нам понадобится:

* второй экструдер
* второй хот-энд в сборе и все прилегающие детали, типа трубки боудена
* каретка на два экструдера. Я использую [такую](http://www.thingiverse.com/thing:1749633).

В общем случае все просто идем в Arduino IDE и правим конфигурацию.

Меняем конфигурацию платы управления на RAMPS 1.4 c 2 экструдерами и подогреваемым столом

    #ifndef MOTHERBOARD
      #define MOTHERBOARD BOARD_RAMPS_14_EEB
    #endif

Указываем кол-во экструдеров:

    #define EXTRUDERS 2

Указываем тип датчика температуры для второго экструдера:

    #define TEMP_SENSOR_1 1

Максимальную температуру:

    #define HEATER_1_MAXTEMP 250

Если надо, устанавливаем направление вращения мотора:

    #define INVERT_E1_DIR true

В целом, если у вас одинаковые моторы на обоих экструдерах, то на этом настройка закончена.

Но если у моторы разные или  на одном экструдере у меня мотор с шестерней подачи диаметром 10мм, а на втором - 7мм, то тут начинаются проблемы с калибровкой.

Как откалибровать второй экструдер?
Идем в пронтерфейс и говорим:

    T1

 Эта команда указывает что сейчас активен экструдер номер 2 (отсчет начинается с 0). Включаем подачу филамента, для подачи будет использоваться число шагов из прошивки, т.е. для первого экструдера. Смотрим разницу и с помощью пропорции получаем кол-во шагов для активного экструдера. У меня из-за разницы в подающих шестернях получилось 80 шагов на мм.

Говорим:

    M92 E80

Этим мы устанавливаем новое кол-во шагов для текущего экструдера. Проверяем, при необходимости подгоняем значение.

После калибровки вылезает проблема - Marlin не поддерживает установку разного числа шагов для разных экструдеров, соответственно в прошивке нам эти данные не сохранить. Придется этот вопрос решать програмно.

Идем в `Slic3r`, я, в основном, использую его, для других слайсеров будут отличия. Переходим на вкладку `Printer Setting -> Custom G-Code`.
Нас интересует поле `Tool change G-Code`. Код в этом поле будет вызываться при каждой смене экструдера.
Пишем туда следующее:

    [[previous_extruder==0]]
    M92 E80
    [[/previous_extruder==0]]
    [[previous_extruder==1]]
    M92 E95
    [[/previous_extruder==1]]

Этот макрос дает следующий эффект - если мы переключились с экструдера 1, то выставляем число шагов текущего экструдера (второго) равным значению которое мы получили при калибровке, в моем случае это 80.
Если мы переключились со второго экструдера на первый - то выставляем для него значение числа шагов равное значению из прошивки.

Дальше идем в `Extruder 2` и выставляем смещение. Если вся эта конструкция собрана на каретке ссылку на которую я давал выше - то смещение по оси X  будет 24, по Y - 0. Для других кареток надо мерять и выставлять фактические значения.


После этого печатаем деталь для [калибровки 2х экструдеров](http://www.thingiverse.com/thing:124450) и точно подгоняем все для идеальной работы.
