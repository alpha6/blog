<!DOCTYPE html>
<html>
    <head>
	<meta charset="utf-8">
        <link href="/theme/css/normalize.css" rel="stylesheet">
        <link href="/theme/css/skeleton.css" rel="stylesheet">
        <link href="/theme/css/statocles-default.css" rel="stylesheet">
        <title>Just another blog</title>
        <link href="/blog/tag/shairport.atom" rel="alternate" type="application/atom+xml">
        <link href="/blog/tag/shairport.rss" rel="alternate" type="application/rss+xml">
        
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">Just another blog</a>
                    <ul>
                        <li>
                            <a href="/">Blog</a>
                        </li>
                    </ul>
                </div>
            </nav>
            
        </header>
        <div class="main container">
            
<div class="row">

    <div class="nine columns">
        <main>

            <article>
                <header>
                    <h1><a href="/blog/2015/05/20/airport-linux/">Превращаем Linux компьютер в AirPlay приемник</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/airplay/" rel="tag">airplay</a>
                        <a href="/blog/tag/linux/" rel="tag">linux</a>
                        <a href="/blog/tag/shairport/" rel="tag">shairport</a>
                    </p>

                    <aside>
                        <p><time datetime="2015-05-20">
                            Posted on 2015-05-20
                        </time>
                        </p>
                    </aside>

                </header>

                <p>Захотелось мне как-то играть музыку с мака на колонки без проводов. Раньше для этого я пользовался AirPort Express, када были воткнуты колонки. Но сия халява кончилась и теперь надо что-то изобретать.</p>

<p>Быстрый поиск по интернетам показал существование демона shairport, который предствляет собой AirPlay приемник для Linux. Проблема в том, что данный демон уже давно не поддерживается и автор прямо отказался от его поддержки. Но благодаря великой силе форков гитхаба был найден проект <a href="https://github.com/mikebrady/shairport-sync">shairport-sync</a>, который является форком shairport с допилами и поддерживается в настоящее время. То что надо!</p>

<p>Итак, краткий мануал по установке. Я взял старый asus eee 900, на котором стоит xubuntu 14.04LTS. По совместительству он работает у меня домашним сервером.</p>

<ul>
<li>Клонируем к себе репозиторий <code>git clone https://github.com/mikebrady/shairport-sync.git</code></li>
<li>Устанавливаем зависимости нужное для сборки <code>apt install build-essential autoconf checkinstall libtool libdaemon-dev libasound2-dev libpopt-dev</code></li>
<li>Устанавливаем Avahi <code>apt install avahi-daemon libavahi-client-dev</code></li>
<li>Устанавливаем зависимости для работы с SSL <code>apt install libssl-dev</code>. Демон умеет работать с OpenSSL или PolarSSL, но этот пакет нужен для обеих библиотек.</li>
<li>Я использовал PolarSSL для сборки, но, в целом, никакой разницы нет. Устанавливаем PolarSSL <code>apt install libpolarssl-dev</code></li>
<li>Запускаем autoconf <code>autoreconf -i -f</code> после этого будет сгенерирован файл configure.</li>
<li><code>$ ./configure --with-alsa --with-avahi --with-ssl=polarssl</code></li>
<li><code>make</code></li>
<li><code>sudo checkinstall</code>. Checkinstall задаст несколько вопросов, на них можно ответить по умолчанию, единственное что надо задать поле <code>version</code> в виде числа. Т.к. по умолчанию туда попадает значение <code>sync</code> и checkinstall падает с ошибкой создания пакета.</li>
</ul>

<p>Почему вместо <code>make install</code> лучше использовать <code>checkinstall</code>? Эта утилита перехватит работу make, отследит куда ставятся все файлы приложения и создаст deb пакет для безопасной установки и удаления приложения.</p>

<p>Конфигурируется демон через редактирования файла <code>/etc/init.d/shairport-sync</code>, я там поменял только название сервиса. Обычно больше ничего не требуется для работы.</p>

<h3>Возможные проблемы</h3>

<p>При загрузке компьютера может появляться сообщение:</p>

<pre><code>Avahi detected that your currently configured local DNS server serves a domain .local. This is inherently incompatible with Avahi and thus Avahi disabled itself. If you want to use Avahi in this network, please contact your administrator and convince him to use a different DNS domain, since .local should be used exclusively for Zeroconf technology.
</code></pre>

<p>Работа Avahi будет останавливаться, соответственно и shairport не запустится. Обычно эта проблема связана с тем, что в DNS сервере есть записи для зоны local.</p>

<p>Проверяется это командой: <code>host -t SOA local.</code> (обратите внимание на точку в конце!). В нормальной ситуации вывод должен быть около такого: </p>

<pre><code>bash-3.2$ host -t SOA local.
Host local. not found: 3(NXDOMAIN)
</code></pre>

<p>Если же в выводе написано: <code>local has SOA record XXX</code>, то ваш DNS транслирует зону local. Обычно это делают провайдеры для работы сервисов типа retracker.local. Если вы этим не пользуетесь - можно просто указать днс Yandex (77.88.8.8/77.88.8.1) или Google(8.8.8.8/8.8.4.4).</p>

<p>После этих настроек и рестарта служб - все должно работать, а на устройствах Apple появится ваше устройство для вывода звука.</p>



            </article>
        </main>

        <ul class="pager">
            <li class="prev">
                <a class="button disabled" href="" rel="next">
                    ← Older
                </a>
            </li>
            <li class="next">
                <a class="button disabled" href="" rel="prev">
                    Newer →
                </a>
            </li>
        </ul>

    </div>

    <div class="three columns sidebar">
        
        <h1>Tags</h1>
        <ul class="list-inline">
            <li><a href="/blog/tag/Automation/">Automation</a></li>
            <li><a href="/blog/tag/LC_ALL/">LC_ALL</a></li>
            <li><a href="/blog/tag/Perl/">Perl</a></li>
            <li><a href="/blog/tag/Rex/">Rex</a></li>
            <li><a href="/blog/tag/Ubuntu/">Ubuntu</a></li>
            <li><a href="/blog/tag/airplay/">airplay</a></li>
            <li><a href="/blog/tag/bugs/">bugs</a></li>
            <li><a href="/blog/tag/elasticsearch/">elasticsearch</a></li>
            <li><a href="/blog/tag/gearman/">gearman</a></li>
            <li><a href="/blog/tag/graylog/">graylog</a></li>
            <li><a href="/blog/tag/graylog2/">graylog2</a></li>
            <li><a href="/blog/tag/io/">io</a></li>
            <li><a href="/blog/tag/linux/">linux</a></li>
            <li><a href="/blog/tag/note/">note</a></li>
            <li><a href="/blog/tag/perl/">perl</a></li>
            <li><a href="/blog/tag/shairport/">shairport</a></li>
            <li><a href="/blog/tag/snippet/">snippet</a></li>
            <li><a href="/blog/tag/ubuntu/">ubuntu</a></li>
        </ul>
        <h1>Feeds</h1>
        <ul class="list-inline">
            <li>
                <a href="/blog/tag/shairport.atom" rel="alternate" type="application/atom+xml">
                    Atom
                </a>
            </li>
            <li>
                <a href="/blog/tag/shairport.rss" rel="alternate" type="application/rss+xml">
                    RSS
                </a>
            </li>
        </ul>
    </div>

</div>

        </div>
        <footer>
            
            <div class="container tagline">
                <a href="http://preaction.github.io/Statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
	<!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter7948447 = new Ya.Metrika({id:7948447, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img alt="" src="//mc.yandex.ru/watch/7948447" style="position:absolute; left:-9999px;"></div></noscript><!-- /Yandex.Metrika counter -->
    </body>
</html>
